generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  COACH
  ADMIN
}

enum AssignmentStatus {
  ACTIVE
  PAUSED
  ENDED
}

// Users table - all user types
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  role         Role     @default(USER)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  coachProfile    Coach?
  userAssignments Assignment[]   @relation("UserAssignments")
  coachAssignments Assignment[]  @relation("CoachAssignments")
  sentMessages    Message[]      @relation("SentMessages")
  refreshTokens   RefreshToken[]

  @@map("users")
}

// Coach profile (extends User with role=COACH)
model Coach {
  id        String  @id @default(uuid())
  userId    String  @unique @map("user_id")
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio       String?
  specialty String?

  @@map("coaches")
}

// Assignment links users to coaches
model Assignment {
  id         String           @id @default(uuid())
  userId     String           @map("user_id")
  coachId    String           @map("coach_id")
  assignedBy String?          @map("assigned_by")
  status     AssignmentStatus @default(ACTIVE)
  createdAt  DateTime         @default(now()) @map("created_at")

  user         User          @relation("UserAssignments", fields: [userId], references: [id], onDelete: Cascade)
  coach        User          @relation("CoachAssignments", fields: [coachId], references: [id], onDelete: Cascade)
  conversation Conversation?

  @@unique([userId, coachId])
  @@map("assignments")
}

// Conversation for each assignment
model Conversation {
  id           String     @id @default(uuid())
  assignmentId String     @unique @map("assignment_id")
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now()) @map("created_at")

  messages Message[]

  @@map("conversations")
}

// Chat messages
model Message {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  senderId       String    @map("sender_id")
  content        String
  sentAt         DateTime  @default(now()) @map("sent_at")
  readAt         DateTime? @map("read_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

// Refresh tokens for JWT auth
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}